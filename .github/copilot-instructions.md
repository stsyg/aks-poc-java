# GitHub Copilot Instructions — AKS PoC Java

## Project Overview

This repository is a **Proof of Concept** for migrating Java applications to Azure Kubernetes Service (AKS). It demonstrates:

- **AKS private cluster** with Node Autoprovision (NAP) — Microsoft's managed Karpenter
- **KEDA** for event-driven pod autoscaling (extends HPA)
- **Karpenter (NAP)** for automatic right-sized node provisioning
- **Spring PetClinic Microservices** as the demo Java application (7 services)
- **Azure Load Testing** for generating load and visualizing scaling behavior
- **Azure CNI Overlay + Cilium** networking
- Microsoft-recommended AKS add-ons: Workload Identity, App Routing, Image Cleaner, Azure Policy, Key Vault Secrets Provider

## Architecture

The customer is migrating from AWS/GCP to Azure. They are familiar with Karpenter on EKS and want the same experience on AKS via NAP. The cluster is private (API server accessible only via VNet + S2S VPN) with app services exposed via public Ingress.

**Scaling chain**: KEDA ScaledObject → HPA (managed by KEDA) → Pending Pods → Karpenter (NAP) → Right-sized VM provisioned.

## Repository Structure

```
.devcontainer/          — DevContainer with az CLI, kubectl, Java 21, Maven, jq
.github/                — Copilot instructions and prompt files
docs/                   — Plan, SOP (Standard Operating Procedure), architecture diagrams
k8s/                    — Kubernetes manifests (namespace, nodepools, apps, scaling, ingress)
scripts/                — Bash scripts (deploy-infra, deploy-apps, teardown)
.env.example            — Template for environment variables
```

## Key Constraints

1. **No secrets in the repo.** Use `.env` file (gitignored). All scripts source from `.env`.
2. **All container images come from ACR**, imported via `az acr import` from DockerHub. Never reference DockerHub directly in K8s manifests.
3. **Resource names use a random suffix** (e.g., `aks-poc-java-d45j5`). Generated by `deploy-infra.sh`, stored in `.env`.
4. **KEDA ScaledObjects, not manual HPAs.** Never create a standalone HPA for a deployment that has a KEDA ScaledObject — they conflict. Define all triggers (CPU, Prometheus, etc.) inside the ScaledObject.
5. **Tags on all Azure resources**: `environment=Lab`, `designation=Poc`, `provisioner=Manual`.
6. **Private cluster**: API server is only accessible via VNet. Use `az aks command invoke` as fallback if DNS resolution fails.

## Technology Stack

| Component | Technology |
|-----------|-----------|
| Language | Java 21 (Microsoft OpenJDK) |
| Framework | Spring Boot 3.x, Spring Cloud |
| Container registry | Azure Container Registry (Basic) |
| Kubernetes | AKS with NAP (Karpenter) |
| Pod scaling | KEDA (managed add-on) |
| Node scaling | NAP / Karpenter |
| Networking | Azure CNI Overlay + Cilium |
| Ingress | Application Routing (managed NGINX) |
| Load testing | Azure Load Testing |
| Monitoring | Azure Monitor + Container Insights |
| IaC | az CLI scripts |
| Secrets | .env file (gitignored) |

## Commands

- **Deploy infrastructure**: `./scripts/deploy-infra.sh`
- **Deploy applications**: `./scripts/deploy-apps.sh`
- **Teardown everything**: `./scripts/teardown.sh`

## Reference Documents

- [docs/plan.md](../docs/plan.md) — Authoritative decisions and architecture plan
- [docs/sop.md](../docs/sop.md) — Step-by-step Standard Operating Procedure
- [docs/architecture.md](../docs/architecture.md) — Mermaid architecture diagrams
